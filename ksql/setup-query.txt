DROP TABLE FUND_PRICE_TABLE;
DROP STREAM FUND_METADATA_FLAT;
DROP STREAM FUND_METADATA_STREAM;





CREATE STREAM FUND_METADATA_STREAM (
    after STRUCT<
        fund_code STRING,
        fund_price DOUBLE
    >
) WITH (
    KAFKA_TOPIC='pgsrc.public.fund_metadata',
    VALUE_FORMAT='JSON'
);

CREATE STREAM FUND_METADATA_FLAT AS
SELECT
    after->fund_code AS fund_code,
    after->fund_price AS fund_price
FROM FUND_METADATA_STREAM
EMIT CHANGES;

CREATE TABLE FUND_PRICE_TABLE AS
SELECT
    fund_code,
    LATEST_BY_OFFSET(fund_price) AS fund_price
FROM FUND_METADATA_FLAT
GROUP BY fund_code
EMIT CHANGES;

SELECT * FROM FUND_PRICE_TABLE EMIT CHANGES LIMIT 10;
